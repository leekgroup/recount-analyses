---
author: "Andrew E. Jaffe and Kasper D. Hansen"
title: Comparison of Recount with GTEx"
date: 'July 18, 2016'
output:
  BiocStyle::html_document:
    toc: true
  pdf_document:
    toc: true
---

```{r docSetup, dev = 'CairoPNG', echo = FALSE}
## Set device option
library('knitr')
opts_chunk$set(dev = 'CairoPNG')
```


```{r 'setup', echo = FALSE, warning = FALSE, message = FALSE}
timestart <- Sys.time()

## Bib setup
library('knitcitations')

## Load knitcitations with a clean bibliography
cleanbib()
cite_options(hyperlink = 'to.doc', citation_format = 'text', style = 'html')

## Write bibliography information
bibs <- c(
    ballgown = citation('ballgown'),
    BiocStyle = citation('BiocStyle'),
    coop = citation('coop')[1],
    devtools = citation('devtools'),
    edgeR = citation('edgeR')[2],
    knitcitations = citation('knitcitations'),
    'org.Hs.eg.db' = citation('org.Hs.eg.db'),
    R = citation(),
    readr = citation('readr'),
    recount = citation('recount'),
    rmarkdown = citation('rmarkdown'),
    rtracklayer = citation('rtracklayer'),
    stringr = citation('stringr'),
    SummarizedExperiment = citation('SummarizedExperiment')
)

write.bibtex(bibs,
    file = 'gtex_analysis.bib')
bib <- read.bibtex('gtex_analysis.bib')

## Assign short names
names(bib) <- names(bibs)
```

# Overview

This document compares GTEx data release v6 to Recount.  The main issue addressed in this document is mapping up genes and samples between the two datasets.  The annotations are different:

- GTEx uses Gencode v19 mapped to hg19.
- Recount uses UCSC knownGene as represented by the `TxDb.Hsapiens.UCSC.hg38.knownGene` package, mapped to hg38.

# Dependencies

## R packages

```{r dependencies}
library('ballgown')
library('coop')
library('org.Hs.eg.db')
library('readr')
library('recount')
library('rtracklayer')
library('stringr')
library('SummarizedExperiment')
library('limma')
library('edgeR')
```

## Data objects

### From Recount

### From GTEx website

We have downloaded the annotation GTF files as well as the raw gene count matrix from the [GTEx portal](http://www.gtexportal.org).

```{r gtexWebsite}
dataPath <- "/dcs01/ajaffe/GTEX/V6" # wherever data was downloaded
gtexGtf <- import(file.path(dataPath, "gencode.v19.genes.patched_contigs.gtf"))
gtexData <- read_tsv(file.path(dataPath,
    "GTEx_Analysis_v6_RNA-seq_RNA-SeQCv1.1.8_gene_reads.gct.gz"),
		skip=2, progress=FALSE)
gtexCounts <- gtexData[, 3:ncol(gtexData)]
rownames(gtexCounts) <- gtexData$Name
```

### From elsewhere

These are the the Rail-RNA processed samples

```{r loadObjectsRecount}
# For when the data is available via recount:
## download_study('SRP012682')
## load('SRP012682/rse_gene.Rdata')

# Will remove this line in the future and uncomment the above
load("/dcl01/leek/data/recount-website/rse/rse_gtex/SRP012682/rse_gene.Rdata")
gtexPd <- colData(rse_gene)
```

Let's match everything up.

```{r matchIDs}
mm <- match(colnames(gtexCounts), gtexPd$sampid)
gtexCounts <- gtexCounts[,!is.na(mm)]
gtexPd <- gtexPd[mm[!is.na(mm)],]
rse_gene <- rse_gene[,mm[!is.na(mm)]]
```

# Mapping GTEx annotation

We map between version by using ENTREZ gene ids.  The Recount representation is already using ENTREZ gene ids, but we need to map GTEx data to ENTREZ.

```{r GTExmap}
gtexMap <- gtexGtf[!duplicated(gtexGtf$gene_id)]
names(gtexMap) <- gtexMap$gene_id
gtexMap <- gtexMap[rownames(gtexCounts)]
stopifnot(all(rownames(gtexMap) == rownames(gtexCounts)))
gtexMap$EnsemblGeneID <- ballgown:::ss(gtexMap$gene_id, "\\.")
eid2ens <- select(org.Hs.eg.db, gtexMap$EnsemblGeneID,
    "ENTREZID", "ENSEMBL")
eid2ens <- CharacterList(split(eid2ens$ENTREZID, eid2ens$ENSEMBL))
gtexMap$EntrezID <- eid2ens[gtexMap$EnsemblGeneID]
table(elementLengths(gtexMap$EntrezID))
table(gtexMap$gene_type, elementLengths(gtexMap$EntrezID) == 1)
```

Basically, only protein coding genes have a ENTREZ id.  We keep only the protein coding genes which are uniquely mapped to an ENTREZ id.

```{r keepMapping}
eidIndex <- which(elementLengths(gtexMap$EntrezID)==1 &
    gtexMap$gene_type == "protein_coding")
gtexMap <- gtexMap[eidIndex,]
gtexCounts <- gtexCounts[eidIndex,]
gtexMap$EntrezID <- sapply(gtexMap$EntrezID,"[", 1)
```

Now, we still have multiple Ensembl gene ids mapping to the same ENTREZ id.  We drop those as well

```{r dropMultiEntrez}
dropIDs <- gtexMap$EntrezID[duplicated(gtexMap$EntrezID)]
keepIdx <- which(!gtexMap$EntrezID %in% dropIDs)
gtexCounts <- gtexCounts[keepIdx, ]
gtexMap <- gtexMap[keepIdx, ]
rownames(gtexCounts) <- names(gtexMap) <- gtexMap$EntrezID
dim(gtexCounts)
```


Let's load data from Recount.

```{r}
rse_gene_scale <- scale_counts(rse_gene)
recountCounts <- assays(rse_gene_scale)$counts
recountMap <- rowRanges(rse_gene_scale)
stopifnot(all(colnames(recountCounts) == rownames(gtexPd)))

## match by gene
geneMatch <- match(recountMap$gene_id, gtexMap$EntrezID )
recountCounts <- recountCounts[!is.na(geneMatch), ]
recountMap <- recountMap[!is.na(geneMatch)]

gtexMap <- gtexMap[geneMatch[!is.na(geneMatch)], ]
gtexCounts <- gtexCounts[geneMatch[!is.na(geneMatch)], ]
stopifnot(all(rownames(gtexCounts) == rownames(recountCounts)))

# save(gtexCounts, gtexMap, gtexPd, recountCounts, recountMap, file =
#    "GTEx_websiteAndRecount_EntrezMatched_17559_vs_8551_reproduced.Rdata",
#    compress = TRUE)
```

# Comparison

```{r loadMap}
# load("GTEx_websiteAndRecount_EntrezMatched_17559_vs_8551_reproduced.Rdata")
gtexCounts <- as.matrix(gtexCounts)
ind = which(colSums(is.na(gtexCounts)) == 0)
gtexCounts2 <- log2(sweep(gtexCounts, MARGIN = 2, FUN = "/", 
    colSums(gtexCounts) / (4 * 10^7 )) + 1)[,ind]
recountCounts2 <- log2(recountCounts[,ind]+1)
gtexPd2 = gtexPd[ind,]
```

```{r rawCounts comparisons}
normCors <- sapply(seq_len(nrow(gtexCounts2)),
	function(ii) pcor(gtexCounts2[ii, ],  recountCounts2[ii,]))
summary(normCors)
sum(normCors <= 0.95, na.rm = TRUE)
sum(normCors <= 0.80, na.rm = TRUE)
mean(normCors >= 0.99, na.rm = TRUE)
```

```{r normCountsPlot, plot = TRUE}
pdf(file = "normCorrelations.pdf")
dens <- density(normCors, from = -1,
	to = 1, na.rm = TRUE, n = 4096)
plot(dens, xlab = "Pearson correlation",
	main = "Size-scaled counts")
plot(dens, xlab = "Pearson correlation",
     main = "Size-scaled counts", xlim = c(0.9,1))
dev.off()
```

# Differential expression

Between colon and blood

```{r 'incomplete', eval = FALSE}
indTissue = c(which(gtexPd2$smts == "Colon"),
	which(gtexPd2$smtsd == "Whole Blood"))
gtexPd2_sub = gtexPd2[indTissue,]
recountCounts2_sub = recountCounts2[,indTissue]
gtexCounts2_sub = gtexCounts2[,indTissue]
design <- model.matrix(~ smts , data = gtexPd2_sub)
```

Using recount:

```{r, recountDE}
dge_recount = DGEList(counts = recountCounts2_sub)
dge_recount = calcNormFactors(dge_recount)
v_recount = voom(dge_recount, design,plot=FALSE)
fit_recount = lmFit(v_recount, design)
eb_recount = ebayes(fit_recount)
out_recount = data.frame(log2FC = fit_recount$coef[,2],
	tstat = eb_recount$t[,2], pvalue = eb_recount$p[,2])
colnames(out_recount) = paste0(colnames(out_recount),"_recount")
```

And using original counts:

```{r, gtexDE}
dge_gtex = DGEList(counts = gtexCounts2_sub)
dge_gtex = calcNormFactors(dge_gtex)
v_gtex = voom(dge_gtex, design,plot=FALSE)
fit_gtex = lmFit(v_gtex, design)
eb_gtex = ebayes(fit_gtex)
out_gtex = data.frame(log2FC = fit_gtex$coef[,2],
	tstat = eb_gtex$t[,2], pvalue = eb_gtex$p[,2])
colnames(out_gtex) = paste0(colnames(out_gtex),"_gtex")
```

Compare:

```{r, compareTstat}
M = out_recount$log2FC_recount - out_gtex$log2FC_gtex
A = ( out_recount$log2FC_recount + out_gtex$log2FC_gtex)/2
plot(M ~ A, xlab="Average Log2 Fold Change", 
	ylab="Colon-Blood Difference in log2FCs",
	pch = 21, bg="grey")
```	

The R-squared is `r 
cor(out_recount$log2FC_recount ,out_gtex$log2FC_gtex)^2`

# Reproducibility


This analysis report was made possible thanks to:

* R `r citep(bib[['R']])`
* `r Biocpkg('ballgown')` `r citep(bib[['ballgown']])`
* `r Biocpkg('BiocStyle')` `r citep(bib[['BiocStyle']])`
* `r CRANpkg('coop')` `r citep(bib[['coop']])`
* `r CRANpkg('devtools')` `r citep(bib[['devtools']])`
* `r Biocpkg('edgeR')` `r citep(bib[['edgeR']])`
* `r CRANpkg('knitcitations')` `r citep(bib[['knitcitations']])`
* `r Biocpkg('org.Hs.eg.db')` `r citep(bib[['org.Hs.eg.db']])`
* `r CRANpkg('readr')` `r citep(bib[['readr']])`
* `r Githubpkg('leekgroup/recount')` `r citep(bib[['recount']])`
* `r CRANpkg('rmarkdown')` `r citep(bib[['rmarkdown']])`
* `r Biocpkg('rtracklayer')` `r citep(bib[['rtracklayer']])`
* `r CRANpkg('stringr')` `r citep(bib[['stringr']])`
* `r Biocpkg('SummarizedExperiment')` `r citep(bib[['SummarizedExperiment']])`


[Bibliography file](gtex_analysis.bib)

```{r bibliography, results='asis', echo=FALSE, warning = FALSE}
## Print bibliography
bibliography()
```


```{r reproducibility}
## Time spent creating this report:
diff(c(timestart, Sys.time()))

## Date this report was generated
message(Sys.time())

## Reproducibility info
options(width = 120)
devtools::session_info()
```